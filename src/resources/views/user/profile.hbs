<div class="profile-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Enhanced Profile Header -->
                <div class="profile-header">
                    <form action="/user/profile/update/change-avatar?_method=PUT" method="POST"
                        enctype="multipart/form-data" id="avatarForm">
                        <div class="profile-avatar position-relative">
                            {{#if user.avatar}}
                            <img src="{{user.avatar}}" alt="User Avatar" class="rounded-circle" id="avatarPreview">
                            {{else}}
                            <img src="/img/user-avatar/default.jpg" alt="User Avatar" class="rounded-circle" id="avatarPreview">
                            {{/if}}

                            <label class="avatar-overlay" for="avatarInput">
                                <i class="bi bi-camera"></i>
                            </label>

                            <input type="file" name="avatar" id="avatarInput" accept="image/*" style="display: none;" />
                        </div>
                    </form>

                    <div class="profile-info">
                        <h2 class="profile-name">{{user.username}}</h2>
                        <p class="profile-subtitle">
                            <i class="bi bi-calendar3"></i>
                            Member since {{formatDate user.created_at}}
                        </p>
                        
                        <!-- Enhanced Statistics -->
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span class="stat-number">{{totalTasks}}</span>
                                <span class="stat-label">Total Tasks</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">{{completedTasks}}</span>
                                <span class="stat-label">Completed</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">{{pendingTasks}}</span>
                                <span class="stat-label">Pending</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Profile Navigation -->
                <div class="profile-nav">
                    <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab"
                                data-bs-target="#dashboard" type="button" role="tab">
                                <i class="bi bi-speedometer2"></i>
                                Dashboard
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" 
                                data-bs-target="#activity" type="button" role="tab">
                                <i class="bi bi-activity"></i>
                                Activity
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" 
                                data-bs-target="#security" type="button" role="tab">
                                <i class="bi bi-shield-lock"></i>
                                Security
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Enhanced Tab Content -->
                <div class="tab-content" id="profileTabContent">
                    <!-- Dashboard Tab -->
                    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                        <div class="profile-section">
                            <h4 class="section-title">
                                <i class="bi bi-graph-up"></i>
                                Task Statistics
                            </h4>
                            
                            <div class="statistics-grid">
                                <div class="stat-card">
                                    <div class="stat-icon completed">
                                        <i class="bi bi-check-circle"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6>Tasks Completed</h6>
                                        <div class="stat-number">{{completedTasks}}</div>
                                        <div class="stat-description">Successfully finished tasks</div>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <div class="stat-icon pending">
                                        <i class="bi bi-hourglass-split"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h6>Pending Tasks</h6>
                                        <div class="stat-number">{{pendingTasks}}</div>
                                        <div class="stat-description">Tasks in progress</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Tab -->
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <div class="profile-section">
                            <h4 class="section-title">
                                <i class="bi bi-clock-history"></i>
                                Recent Activity
                            </h4>
                            
                            {{#if recentTasks}}
                            <div class="activity-list">
                                {{#each recentTasks}}
                                <div class="activity-item">
                                    <div class="activity-indicator {{#if completed}}completed{{else}}{{#if deleted}}deleted{{else}}pending{{/if}}{{/if}}">
                                    </div>
                                    <div class="activity-details">
                                        <h6>{{title}}</h6>
                                        <div class="activity-time">
                                            <i class="bi bi-clock"></i>
                                            {{#if completed}}
                                            Completed on {{formatDateTime updated_at}}
                                            {{else}}{{#if deleted}}
                                            Deleted on {{formatDateTime updated_at}}
                                            {{else}}
                                            Created on {{formatDateTime created_at}}
                                            {{/if}}{{/if}}
                                        </div>
                                    </div>
                                </div>
                                {{/each}}
                                
                                <div class="text-center mt-3">
                                    <a href="/task" class="btn btn-outline-profile">
                                        <i class="bi bi-arrow-right"></i>
                                        <span>View All Tasks</span>
                                    </a>
                                </div>
                            </div>
                            {{else}}
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No recent activity found</p>
                                <a href="/task/create" class="btn btn-outline-profile">
                                    <i class="bi bi-plus-circle"></i>
                                    Create Your First Task
                                </a>
                            </div>
                            {{/if}}
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div class="profile-section">
                            <h4 class="section-title">
                                <i class="bi bi-shield-check"></i>
                                Account Security
                            </h4>
                            
                            <form action="/user/profile/update/change-password?_method=PUT" method="POST" class="security-form">
                                <div class="form-group">
                                    <label for="currentPassword" class="form-label">
                                        <i class="bi bi-key me-2"></i>
                                        Current Password
                                    </label>
                                    <input type="password" class="form-control" id="currentPassword" 
                                           name="currentPassword" placeholder="Enter your current password" required>
                                </div>

                                <div class="form-group">
                                    <label for="newPassword" class="form-label">
                                        <i class="bi bi-lock me-2"></i>
                                        New Password
                                    </label>
                                    <input type="password" class="form-control" id="newPassword" 
                                           name="newPassword" placeholder="Enter your new password" minlength="6" required>
                                </div>

                                <div class="form-group">
                                    <label for="confirmPassword" class="form-label">
                                        <i class="bi bi-lock-fill me-2"></i>
                                        Confirm New Password
                                    </label>
                                    <input type="password" class="form-control" id="confirmPassword" 
                                           name="confirmPassword" placeholder="Confirm your new password" required>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-warning">
                                        <i class="bi bi-shield-check"></i>
                                        <span>Update Password</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Keep your existing script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        const passwordError = params.get('password-error');
        const passwordSuccess = params.get('password-success');
        const securityTab = new bootstrap.Tab(document.querySelector('#security-tab'));

        if (passwordError) {
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger';
            errorAlert.role = 'alert';
            errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${passwordError}`;
            document.querySelector('#security').prepend(errorAlert);
            securityTab.show();
        } else if (passwordSuccess) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Your password has been successfully updated.',
                confirmButtonText: 'Done',
                confirmButtonColor: '#198754',
            });
            securityTab.show();
        }

        // For updating avatar
        const avatarInput = document.getElementById('avatarInput');
        const avatarForm = document.getElementById('avatarForm');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarError = params.get('avatar-error');
        const avatarSuccess = params.get('avatar-success');

        avatarInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    avatarPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
                avatarForm.submit();
            }
        });

        if (avatarError) {
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger';
            errorAlert.role = 'alert';
            errorAlert.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${avatarError}`;
            document.querySelector('#overview').prepend(errorAlert);
            avatarTab.show();
        } else if (avatarSuccess) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Your avatar has been successfully updated.',
                confirmButtonText: 'Done',
                confirmButtonColor: '#198754',
            });
            avatarTab.show();
        }
    })
</script>